# BIP 150/151 support in Armory
## Overview
As of v0.97, Armory supports [BIP 150](https://github.com/bitcoin/bips/blob/master/bip-0150.mediawiki) and [BIP 151](https://github.com/bitcoin/bips/blob/master/bip-0151.mediawiki) in a specific manner. In particular, Armory can run a headless server on one machine and have an Armory client connect remotely. Such a connection may be configured to be encrypted. If encrypted, after the initial handshake, Armory will attempt to establish a connection, per the BIP 151 spec. After the connection has been established, BIP 150 may be used for authentication purposes. BIP 150 "whitelists" specific IP:Port combinations and performs a basic authentication handshake using pre-determined ECDSA keys. If the handshake succeeds, the connection may proceed, otherwise it will be terminated.

### Caveats
As of Feb. 2019, BIP 150 and BIP 151 are **not** implemented in Bitcoin Core. Usage of BIP 150 and BIP 151 applies only between an Armory supernode server and its Armory clients. Unless otherwise noted in the future, **connections between Armory and Core nodes will not use BIP 150 or BIP 151**.

In addition, the BIP developer ([Jonas Schnelli](https://github.com/jonasschnelli/)) has stated that both BIPs will be significantly overhauled in the near future, and possibly rewritten as a new BIP. The rewrite should increase the possibility of Core support (and, hence, introduce Armory node interoperability). However, it probably won't be backwards compatible with the current implementation.

## Implementation Specifics (CONFIRM)
(The following details need to be confirmed before the final doc is pulled.)

BIP 150 and 151 are mandatory for all connections to ArmoryDB. The handshake is as follows.

- Use WebSockets to connect to ArmoryDB.
- Receive a packet containing the server's public key.
- Initiate and complete the BIP 151 handshake. The BIP 151 keys will always be ephemeral.
- Initiate and complete the BIP 150 handshake. The BIP 150 keys are not ephemeral but may be changed as desired.

At this point, the connection is fully secured.

Rekeys will occur every 10 minutes or 1,000,000,000 bytes transferred, whichever comes first.

Armory uses the version of [libsecp256k1](https://github.com/bitcoin-core/secp256k1) that's found in [libbtc](https://github.com/libbtc/libbtc/tree/master/src/secp256k1). This means that Armory will generate only [low-S](https://bitcoin.stackexchange.com/a/38253) signatures for BIP 150. However, low-S and high-S signautres can be verified.

BIP 150 support is included only for IPv4 and IPv6 connections. The BIP 150 spec mentions support for Tor so that a node can't be fingerprinted if it uses Tor. Armory's support for Tor is very rudimentary and isn't smart enough to recognize when Tor is being used. In order to not give users a false sense of security, BIP 150 will simply not work if Armory's Tor mode is enabled. Should Armory obtain a more robust Tor support method one day, this may be revisited.

BIP 150 identity addresses (aka fingerprints) are available, although there is a nuance discussed in the "Changes to the specs" options. In particular, Armory follows the spec and ignores the changes in the example provided in the spec.

### Changes to the specs (CONFIRM)
(The following details need to be confirmed before the final doc is pulled.)

The implementation of BIP 150 and BIP 151 in Armory isn't a perfect match for what resides in the original documents. Changes include but may not necessarily be limited to:

- The BIP 150 rekey formula has been changed due to a man-in-the-middle attack vector. See the "BIP 150 Man-in-the-Middle Vulnerability and Mitigation" section for more details.
- Unknown peers may be allowed if allowed by the server administrator. In BIP 150, if the server can't find the client's public key, the AUTHCHALLENGE message contents are 32 bytes of 0x00. If the server admin wishes to allow anonymous clients, the message contents are 32 bytes of 0xFF.
- The BIP 150 spec has an error regarding identity addresses (aka fingerprints). The example in BIP 150 doesn't match the supposed design. In particular, the example is TfG4ScDgysrSpodWD4Re5UtXmcLbY5CiUHA (Base58) / 0x0F02CB1F4A4D793731842732C153B8E9923BDB4625531A4214CD (Hex). The example has an identity byte of 0x0F (spec match) and an identity version byte of 0x02 (spec mismatch - spec lists 0xFF01). Using the spec bytes, the example should be 3APokFipWL7E9TERtcFRqtJeGka3YGCAHVD4k (Base58) / 0x0FFF01CB1F4A4D793731842732C153B8E9923BDB46255368436FC9 (Hex). Clarification from the author was sought but never received. The decision was made to follow the spec and ignore the changes in the example.
- BIP 150 and 151 have some ambiguity in the writing. It may be possible for readers to read certain details and come to slightly different conclusions. A PR may eventually be issued against both documents. This may not happen due to the author planning to [rework or abandon BIP 151](https://github.com/bitcoin/bitcoin/pull/14032).

#### BIP 150 Man-in-the-Middle Vulnerability and Mitigation
BIP 150 has a minor man-in-the-middle (MitM) vulnerability, as discovered by goatpig. When the client attempts to contact the server (AUTHCHALLENGE), the server must reply with an acceptable signature (AUTHREPLY) or a failure indicator. MitM doesn't apply here, as the client has the server's public key to verify the signature and essentially issues an ACK to the server. However, when the server sends its own AUTHCHALLENGE on the client's incoming channel, the client never gets an ACK after sending its own AUTHPROPOSE. A MitM attacker could simply tunnel the client's outgoing data while proxying the client's incoming data. The client has no way to absolutely verify the incoming data or to be notified that the server has dropped the connection. BIP 150 also has no built-in mechanism for automatically shutting down a connection, establishing a connection heartbeat, etc.

This particular attack is mitigated by BIP 151, as the incoming and outgoing session IDs are derived from a pair of shared public keys. (Other protocols using unknown sets of keys (e.g., ephemeral keys) may be vulnerable.) Despite the BIP 151 mitigation, Armory has changed the BIP 150 post-authentication rekey protocol. The formula is now as follows:

`2xSHA256(encryption-session-ID || old_symmetric_cipher_key || opposite_channel_cipher_key || requesting-peer-identity-public-key || responding-peer-identity-public-key)`.

### BIP 150 keys
A small binary, *BIP150KeyManager*, is generated when compiling Armory. The binary is used to manage the keys used in BIP 150. See the [BIP150KeyManager README](README_BIP150KeyManager.md) for more information.

### Packet Information
Once the connection is set up, the packets sent back & forth are serialized as follows. These are the raw packets generated as part of the BIP 150/151 process, although the overhead isn't part of the actual BIP 150/151 schemes and are internal to Armory.

Packet size  (4 bytes)
Packet type  (1 byte)
Payload  (N bytes)

## License
Distributed under the MIT License. See the [LICENSE file](LICENSE) for more information.

## Copyright
Copyright (C) 2019 goatpig
